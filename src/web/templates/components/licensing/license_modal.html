<!-- License Management Modal -->
<div class="modal-overlay" id="license-modal" style="display: none;">
    <div class="modal-content license-modal">
        <div class="modal-header">
            <h3 class="modal-title">üîë WARPCORE License Activation</h3>
            <button class="modal-close" onclick="closeLicenseModal()">√ó</button>
        </div>
        
        <div class="modal-body">
            <!-- Current License Status -->
            <div class="license-status-section">
                <h4>Current License</h4>
                <div class="current-license-info">
                    <div class="license-badge {{ license_status.status if license_status else 'inactive' }}" id="current-license-badge">
                        {% if license_status and license_status.status == 'active' %}
                            ‚úÖ {{ current_tier_info.icon }} {{ current_tier_info.name }} License Active
                        {% else %}
                            ‚ùå {{ current_tier_info.icon }} No Active License
                        {% endif %}
                    </div>
                    <div class="license-details" id="current-license-details">
                        {% if license_status and license_status.status == 'active' %}
                            <p><strong>User:</strong> {{ license_status.user_email or 'Licensed User' }}</p>
                            <p><strong>Type:</strong> {{ current_tier_info.name }} ({{ license_status.license_type }})</p>
                            <p><strong>Features:</strong> {{ current_tier_info.feature_count }} features available</p>
                            <p><strong>Description:</strong> {{ current_tier_info.description }}</p>
                            {% if license_status.expires_at %}
                                <p><strong>Expires:</strong> {{ license_status.expires_at }}</p>
                            {% endif %}
                        {% else %}
                            <p><strong>Tier:</strong> {{ current_tier_info.name }} {{ current_tier_info.icon }}</p>
                            <p><strong>Features:</strong> {{ current_tier_info.feature_count }} basic features available</p>
                            <p>{{ current_tier_info.description }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- License Actions -->
            <div class="license-actions-section">
                <div class="license-tabs">
                    <button class="license-tab active" onclick="showLicenseTab('activate')">Activate License</button>
                    <button class="license-tab" onclick="showLicenseTab('trial')">Start Trial</button>
                    <button class="license-tab" onclick="showLicenseTab('upgrade')">Upgrade</button>
                </div>
                
                <!-- Activate License Tab -->
                <div class="license-tab-content active" id="license-tab-activate">
                    <h5>Enter License Key</h5>
                    <form id="license-activate-form">
                        <div class="form-group">
                            <label for="license-key">License Key:</label>
                            <input type="text" id="license-key" placeholder="Enter your license key" class="license-input">
                        </div>
                        <div class="form-group">
                            <label for="user-email">Email Address:</label>
                            <input type="email" id="user-email" placeholder="your.email@company.com" class="license-input">
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="validateLicenseKey()" class="btn-secondary">Validate</button>
                            <button type="submit" class="btn-primary">Activate License</button>
                        </div>
                    </form>
                    <div id="license-validation-result"></div>
                </div>
                
                <!-- Start Trial Tab -->
                <div class="license-tab-content" id="license-tab-trial">
                    <h5>Start Free Trial</h5>
                    <div class="trial-benefits">
                        <p>üÜì Get full access to Professional features for 14 days:</p>
                        <ul>
                            <li>‚úÖ GCP Authentication</li>
                            <li>‚úÖ Kubernetes Operations</li>
                            <li>‚úÖ Live Log Streaming</li>
                            <li>‚úÖ Multi-Environment Support</li>
                            <li>‚úÖ Export Capabilities</li>
                            <li>‚úÖ Advanced Monitoring</li>
                            <li>‚úÖ Priority Support</li>
                        </ul>
                    </div>
                    <form id="trial-form">
                        <div class="form-group">
                            <label for="trial-email">Email Address:</label>
                            <input type="email" id="trial-email" placeholder="your.email@company.com" class="license-input" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Start 14-Day Trial</button>
                        </div>
                    </form>
                </div>
                
                <!-- Upgrade Tab -->
                <div class="license-tab-content" id="license-tab-upgrade">
                    <h5>Upgrade Options</h5>
                    <div class="upgrade-options">
                        {% for option in upgrade_options %}
                            <div class="upgrade-option">
                                <div class="upgrade-header">
                                    <h6>{{ option.icon }} {{ option.name }}</h6>
                                    <div class="upgrade-price">{{ option.price }}</div>
                                </div>
                                <div class="upgrade-features">
                                    <p><strong>{{ option.feature_count }}</strong> features included</p>
                                    <ul>
                                        {% for feature in option.features[:3] %}
                                            <li>{{ feature }}</li>
                                        {% endfor %}
                                        {% if option.features|length > 3 %}
                                            <li>+ {{ option.features|length - 3 }} more features</li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <button class="btn-primary upgrade-btn" onclick="selectUpgrade('{{ option.tier }}')">
                                    Upgrade to {{ option.name }}
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Current License Management -->
            {% if license_status and license_status.status == 'active' %}
                <div class="license-management-section">
                    <h4>License Management</h4>
                    <div class="management-actions">
                        <button class="btn-secondary" onclick="refreshLicenseStatus()">üîÑ Refresh Status</button>
                        <button class="btn-warning" onclick="deactivateLicense()">üîì Deactivate License</button>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeLicenseModal()">Close</button>
        </div>
    </div>
</div>

<script>
// License Modal JavaScript
function showLicenseModal() {
    document.getElementById('license-modal').style.display = 'flex';
}

function closeLicenseModal() {
    document.getElementById('license-modal').style.display = 'none';
}

// Generate hardware fingerprint for license binding
function getHardwareSignature() {
    // Generate hardware fingerprint for license binding
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Hardware fingerprint', 2, 2);
    
    const signature = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        canvas.toDataURL()
    ].join('|');
    
    // Simple hash function
    let hash = 0;
    for (let i = 0; i < signature.length; i++) {
        const char = signature.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    
    return Math.abs(hash).toString(16);
}

// Feedback functions
function showLoading(message) {
    const resultDiv = document.getElementById('license-validation-result');
    resultDiv.innerHTML = `<div class="loading"><span class="spinner"></span> ${message}</div>`;
}

function showSuccess(message) {
    const resultDiv = document.getElementById('license-validation-result');
    resultDiv.innerHTML = `<div class="success">${message}</div>`;
}

function showError(message) {
    const resultDiv = document.getElementById('license-validation-result');
    resultDiv.innerHTML = `<div class="error">${message}</div>`;
}

// License activation polling
async function pollLicenseActivation(licenseKey, maxAttempts = 10) {
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        try {
            const response = await fetch('http://localhost:8001/api/license/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    license_key: licenseKey,
                    hardware_signature: getHardwareSignature()
                })
            });
            
            const result = await response.json();
            
            if (result.valid) {
                showSuccess('‚úÖ License activated successfully!');
                setTimeout(() => location.reload(), 2000);
                return true;
            }
            
            if (attempt < maxAttempts) {
                showLoading(`üîÑ Activating license... (${attempt}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 3000));
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
    }
    
    showError('‚ùå License activation timed out. Please try again.');
    return false;
}

function showLicenseTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.license-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`button[onclick="showLicenseTab('${tabName}')"]`).classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.license-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`license-tab-${tabName}`).classList.add('active');
}

async function validateLicenseKey() {
    const licenseKey = document.getElementById('license-key').value;
    const resultDiv = document.getElementById('license-validation-result');
    
    if (!licenseKey) {
        showError('Please enter a license key');
        return;
    }
    
    // Check WARP format first
    const warpFormat = /^WARP-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
    if (!warpFormat.test(licenseKey)) {
        showError('Invalid format. License keys should be WARP-XXXX-XXXX-XXXX');
        return;
    }
    
    showLoading('Validating license key...');
    
    try {
        const response = await fetch('http://localhost:8001/api/license/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                license_key: licenseKey,
                hardware_signature: getHardwareSignature()
            })
        });
        
        const result = await response.json();
        
        if (result.valid) {
            showSuccess('‚úÖ License key is valid!');
        } else {
            showError(`‚ùå ${result.error || 'Invalid license key'}`);
        }
    } catch (error) {
        showError('‚ùå Validation failed - check connection to license server');
        console.error('Validation error:', error);
    }
}

// Handle license activation form
document.getElementById('license-activate-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const licenseKey = document.getElementById('license-key').value;
    const userEmail = document.getElementById('user-email').value;
    
    if (!licenseKey || !userEmail) {
        showError('Please fill in all fields');
        return;
    }
    
    // Validate format first
    const warpFormat = /^WARP-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
    if (!warpFormat.test(licenseKey)) {
        showError('Invalid format. License keys should be WARP-XXXX-XXXX-XXXX');
        return;
    }
    
    showLoading('Activating license...');
    
    // Start polling for activation status
    const success = await pollLicenseActivation(licenseKey);
    
    if (success) {
        // Store license key for future use
        localStorage.setItem('warpcore_license_key', licenseKey);
        localStorage.setItem('warpcore_license_email', userEmail);
    }
});

// Handle trial form
document.getElementById('trial-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('trial-email').value;
    
    if (!email) {
        showError('Please enter your email address');
        return;
    }
    
    showLoading('Generating 14-day trial license...');
    
    try {
        const response = await fetch('http://localhost:8001/api/license/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                user_email: email,
                user_name: email.split('@')[0],
                license_type: 'trial',
                hardware_signature: getHardwareSignature()
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const licenseKey = result.license_key;
            showSuccess(`‚úÖ Trial license generated: ${licenseKey}`);
            
            // Store for future use
            localStorage.setItem('warpcore_license_key', licenseKey);
            localStorage.setItem('warpcore_license_email', email);
            
            // Auto-activate by polling
            setTimeout(async () => {
                await pollLicenseActivation(licenseKey);
            }, 1000);
        } else {
            showError('Trial generation failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        showError('Trial generation failed: ' + error.message);
        console.error('Trial generation error:', error);
    }
});

async function refreshLicenseStatus() {
    try {
        const response = await fetch('/api/license/status');
        const result = await response.json();
        
        if (result.success) {
            alert('License status refreshed! Page will reload.');
            location.reload();
        } else {
            alert('Failed to refresh license status');
        }
    } catch (error) {
        alert('Failed to refresh license status: ' + error.message);
    }
}

async function deactivateLicense() {
    if (!confirm('Are you sure you want to deactivate your license? This will revert to the basic tier.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/license/deactivate', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('License deactivated. Page will reload.');
            location.reload();
        } else {
            alert('Failed to deactivate license: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to deactivate license: ' + error.message);
    }
}

function selectUpgrade(tier) {
    alert(`Upgrade to ${tier} selected. Contact sales for licensing options.`);
}

// Close modal when clicking outside
document.getElementById('license-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeLicenseModal();
    }
});
</script>